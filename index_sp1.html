<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>BPMN – SP1 · Recolección y Validación (Layout ordenado)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/bpmn-js@11.5.0/dist/bpmn-modeler.development.js"></script>
  <style>
    html, body { height: 100%; margin: 0; background:#fafafa; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .toolbar { display:flex; gap:8px; align-items:center; padding:10px; border-bottom:1px solid #e6e6e6; background:#fff; position:sticky; top:0; z-index:10; }
    .toolbar a, .toolbar button { padding:8px 12px; border:1px solid #d8d8d8; background:#fff; border-radius:8px; cursor:pointer; text-decoration:none; color:#111; }
    .toolbar a:hover, .toolbar button:hover { background:#f3f3f3; }
    .hint { margin-left:auto; color:#666; font-size:12px; }
    #canvas { height: calc(100vh - 56px); }
  </style>
</head>
<body>
  <div class="toolbar">
    <a href="./index_overview.html">← Vista General</a>
    <strong>SP1 · Recolección y validación (ordenado)</strong>
    <button id="btnFit">Ajustar</button>
    <button id="btnDownloadBPMN">.bpmn</button>
    <button id="btnDownloadSVG">.svg</button>
    <span class="hint">Happy path horizontal; excepciones abajo; líneas ortogonales</span>
  </div>
  <div id="canvas"></div>

  <script type="text/plain" id="bpmn-xml">
<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
  id="Defs_SP1_Orderly" targetNamespace="http://bpmn.io/schema/bpmn">

  <bpmn:process id="P_SP1" isExecutable="false" name="SP1 · Recolección y validación de información de indicadores">
    <bpmn:startEvent id="SP1_Start" name="Inicio SP1">
      <bpmn:outgoing>F0</bpmn:outgoing>
    </bpmn:startEvent>

    <bpmn:task id="SP1_T_Solicitar" name="Solicitar información a áreas responsables">
      <bpmn:incoming>F0</bpmn:incoming>
      <bpmn:outgoing>F1</bpmn:outgoing>
    </bpmn:task>

    <bpmn:task id="SP1_T_Recibir" name="Recibir reportes y documentos fuente">
      <bpmn:incoming>F1</bpmn:incoming>
      <bpmn:outgoing>F2</bpmn:outgoing>
    </bpmn:task>

    <!-- Boundary Timer + Escalation ordenados debajo del task -->
    <bpmn:boundaryEvent id="SP1_BE_Timer" name="Plazo vencido" attachedToRef="SP1_T_Recibir" cancelActivity="false">
      <bpmn:timerEventDefinition />
      <bpmn:outgoing>F_Timer_toMsg</bpmn:outgoing>
    </bpmn:boundaryEvent>

    <bpmn:intermediateThrowEvent id="SP1_Evt_Recordatorio" name="Enviar recordatorio (mensaje)">
      <bpmn:incoming>F_Timer_toMsg</bpmn:incoming>
      <bpmn:outgoing>F_Msg_toEscal</bpmn:outgoing>
      <bpmn:messageEventDefinition />
    </bpmn:intermediateThrowEvent>

    <bpmn:intermediateThrowEvent id="SP1_Evt_Escalar" name="Escalar retraso">
      <bpmn:incoming>F_Msg_toEscal</bpmn:incoming>
      <bpmn:escalationEventDefinition />
    </bpmn:intermediateThrowEvent>

    <bpmn:task id="SP1_T_Validar" name="Validar coherencia, fechas, unidades y consistencia">
      <bpmn:incoming>F2</bpmn:incoming>
      <bpmn:outgoing>F3</bpmn:outgoing>
    </bpmn:task>

    <bpmn:exclusiveGateway id="SP1_G_XOR" name="¿Datos coherentes?">
      <bpmn:incoming>F3</bpmn:incoming>
      <bpmn:outgoing>F_OK</bpmn:outgoing>
      <bpmn:outgoing>F_NOK</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:task id="SP1_T_BaseOK" name="Base validada y trazable">
      <bpmn:incoming>F_OK</bpmn:incoming>
      <bpmn:outgoing>F_End</bpmn:outgoing>
    </bpmn:task>

    <bpmn:task id="SP1_T_Observar" name="Registrar observaciones y solicitar corrección">
      <bpmn:incoming>F_NOK</bpmn:incoming>
      <bpmn:outgoing>F_Back</bpmn:outgoing>
    </bpmn:task>

    <bpmn:endEvent id="SP1_End" name="Fin SP1">
      <bpmn:incoming>F_End</bpmn:incoming>
    </bpmn:endEvent>

    <!-- Datos -->
    <bpmn:dataObject id="SP1_DO_Evidencias" name="Paquete de evidencias"/>
    <bpmn:dataObject id="SP1_DO_Plantilla" name="Plantilla de indicadores"/>
    <bpmn:dataStoreReference id="SP1_DS_Brutos" name="Repositorio indicadores (brutos)"/>

    <bpmn:dataInputAssociation id="SP1_DA1">
      <bpmn:sourceRef>SP1_DO_Evidencias</bpmn:sourceRef>
      <bpmn:targetRef>SP1_T_Validar</bpmn:targetRef>
    </bpmn:dataInputAssociation>
    <bpmn:dataInputAssociation id="SP1_DA2">
      <bpmn:sourceRef>SP1_DO_Plantilla</bpmn:sourceRef>
      <bpmn:targetRef>SP1_T_Validar</bpmn:targetRef>
    </bpmn:dataInputAssociation>
    <bpmn:dataOutputAssociation id="SP1_DA3">
      <bpmn:sourceRef>SP1_T_BaseOK</bpmn:sourceRef>
      <bpmn:targetRef>SP1_DS_Brutos</bpmn:targetRef>
    </bpmn:dataOutputAssociation>

    <!-- Flujos -->
    <bpmn:sequenceFlow id="F0" sourceRef="SP1_Start" targetRef="SP1_T_Solicitar"/>
    <bpmn:sequenceFlow id="F1" sourceRef="SP1_T_Solicitar" targetRef="SP1_T_Recibir"/>
    <bpmn:sequenceFlow id="F_Timer_toMsg" sourceRef="SP1_BE_Timer" targetRef="SP1_Evt_Recordatorio"/>
    <bpmn:sequenceFlow id="F_Msg_toEscal" sourceRef="SP1_Evt_Recordatorio" targetRef="SP1_Evt_Escalar"/>
    <bpmn:sequenceFlow id="F2" sourceRef="SP1_T_Recibir" targetRef="SP1_T_Validar"/>
    <bpmn:sequenceFlow id="F3" sourceRef="SP1_T_Validar" targetRef="SP1_G_XOR"/>
    <bpmn:sequenceFlow id="F_OK" name="Sí" sourceRef="SP1_G_XOR" targetRef="SP1_T_BaseOK"/>
    <bpmn:sequenceFlow id="F_NOK" name="No" sourceRef="SP1_G_XOR" targetRef="SP1_T_Observar"/>
    <bpmn:sequenceFlow id="F_Back" name="Reenvío corregido" sourceRef="SP1_T_Observar" targetRef="SP1_T_Recibir"/>
    <bpmn:sequenceFlow id="F_End" sourceRef="SP1_T_BaseOK" targetRef="SP1_End"/>

    <!-- Nota -->
    <bpmn:textAnnotation id="SP1_Nota">
      <bpmn:text>Mejoras: formularios estandarizados, integraciones; recolección automatizada.</bpmn:text>
    </bpmn:textAnnotation>
    <bpmn:association id="SP1_Assoc_Nota" sourceRef="SP1_T_Validar" targetRef="SP1_Nota"/>
  </bpmn:process>

  <!-- DIAGRAM INTERCHANGE: Layout ordenado y líneas ortogonales -->
  <bpmndi:BPMNDiagram id="DI_SP1">
    <bpmndi:BPMNPlane id="PL_SP1" bpmnElement="P_SP1">

      <!-- Fila principal (y=200 aprox) -->
      <bpmndi:BPMNShape id="SP1_Start_di" bpmnElement="SP1_Start"><dc:Bounds x="120" y="190" width="36" height="36"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SP1_T_Solicitar_di" bpmnElement="SP1_T_Solicitar"><dc:Bounds x="180" y="180" width="240" height="56"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SP1_T_Recibir_di" bpmnElement="SP1_T_Recibir"><dc:Bounds x="440" y="180" width="260" height="56"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SP1_T_Validar_di" bpmnElement="SP1_T_Validar"><dc:Bounds x="730" y="180" width="260" height="56"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SP1_G_XOR_di" bpmnElement="SP1_G_XOR" isMarkerVisible="true"><dc:Bounds x="1020" y="192" width="40" height="40"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SP1_T_BaseOK_di" bpmnElement="SP1_T_BaseOK"><dc:Bounds x="1080" y="180" width="260" height="56"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SP1_End_di" bpmnElement="SP1_End"><dc:Bounds x="1360" y="190" width="36" height="36"/></bpmndi:BPMNShape>

      <!-- Excepción (segunda fila, y=360) -->
      <bpmndi:BPMNShape id="SP1_T_Observar_di" bpmnElement="SP1_T_Observar"><dc:Bounds x="1080" y="340" width="280" height="56"/></bpmndi:BPMNShape>

      <!-- Timer + mensaje + escalación (debajo de Recibir) -->
      <bpmndi:BPMNShape id="SP1_BE_Timer_di" bpmnElement="SP1_BE_Timer"><dc:Bounds x="630" y="238" width="18" height="18"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SP1_Evt_Recordatorio_di" bpmnElement="SP1_Evt_Recordatorio"><dc:Bounds x="610" y="300" width="28" height="28"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SP1_Evt_Escalar_di" bpmnElement="SP1_Evt_Escalar"><dc:Bounds x="650" y="300" width="28" height="28"/></bpmndi:BPMNShape>

      <!-- Datos (a la derecha, sin cruzar el flujo) -->
      <bpmndi:BPMNShape id="SP1_DO_Evidencias_di" bpmnElement="SP1_DO_Evidencias"><dc:Bounds x="760" y="260" width="36" height="36"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SP1_DO_Plantilla_di" bpmnElement="SP1_DO_Plantilla"><dc:Bounds x="806" y="260" width="36" height="36"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SP1_DS_Brutos_di" bpmnElement="SP1_DS_Brutos"><dc:Bounds x="1360" y="260" width="60" height="50"/></bpmndi:BPMNShape>

      <!-- Secuencias (waypoints ortogonales) -->
      <bpmndi:BPMNEdge id="F0_di" bpmnElement="F0">
        <di:waypoint x="156" y="208"/><di:waypoint x="180" y="208"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="F1_di" bpmnElement="F1">
        <di:waypoint x="420" y="208"/><di:waypoint x="440" y="208"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="F2_di" bpmnElement="F2">
        <di:waypoint x="700" y="208"/><di:waypoint x="730" y="208"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="F3_di" bpmnElement="F3">
        <di:waypoint x="990" y="208"/><di:waypoint x="1020" y="212"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="F_OK_di" bpmnElement="F_OK">
        <di:waypoint x="1040" y="212"/><di:waypoint x="1080" y="208"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="F_NOK_di" bpmnElement="F_NOK">
        <!-- Baja vertical y luego derecha hacia la tarea de observaciones -->
        <di:waypoint x="1040" y="212"/><di:waypoint x="1040" y="368"/><di:waypoint x="1080" y="368"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="F_End_di" bpmnElement="F_End">
        <di:waypoint x="1340" y="208"/><di:waypoint x="1360" y="208"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="F_Back_di" bpmnElement="F_Back">
        <!-- Salida de Observaciones: derecha, arriba por carril lateral, izquierda en L hasta Recibir -->
        <di:waypoint x="1360" y="368"/>
        <di:waypoint x="1380" y="368"/>
        <di:waypoint x="1380" y="150"/>
        <di:waypoint x="600" y="150"/>
        <di:waypoint x="600" y="208"/>
      </bpmndi:BPMNEdge>

      <!-- Timer -> Mensaje -> Escalación en línea ordenada bajo Recibir -->
      <bpmndi:BPMNEdge id="F_Timer_toMsg_di" bpmnElement="F_Timer_toMsg">
        <di:waypoint x="639" y="247"/><di:waypoint x="624" y="300"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="F_Msg_toEscal_di" bpmnElement="F_Msg_toEscal">
        <di:waypoint x="638" y="314"/><di:waypoint x="664" y="314"/>
      </bpmndi:BPMNEdge>

    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
  </script>

  <script>
    (async function () {
      const modeler = new BpmnJS({ container: '#canvas' });
      const xml = document.getElementById('bpmn-xml').textContent.trim();

      try {
        await modeler.importXML(xml);
        modeler.get('canvas').zoom('fit-viewport', 'auto');
      } catch (err) {
        console.error('Error al importar BPMN:', err);
        alert('No se pudo cargar el diagrama. Revisa la consola.');
      }

      document.getElementById('btnFit').addEventListener('click', () => {
        modeler.get('canvas').zoom('fit-viewport', 'auto');
      });
      document.getElementById('btnDownloadBPMN').addEventListener('click', async () => {
        try {
          const { xml } = await modeler.saveXML({ format: true });
          download('sp1_layout_ordenado.bpmn', xml, 'text/xml');
        } catch (e) { console.error(e); }
      });
      document.getElementById('btnDownloadSVG').addEventListener('click', async () => {
        try {
          const { svg } = await modeler.saveSVG();
          download('sp1_layout_ordenado.svg', svg, 'image/svg+xml');
        } catch (e) { console.error(e); }
      });

      function download(filename, data, mime) {
        const blob = new Blob([data], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; a.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      }
    })();
  </script>
</body>
</html>
