<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>BPMN – SP2 · Consolidación y Análisis (Layout ordenado)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/bpmn-js@11.5.0/dist/bpmn-modeler.development.js"></script>
  <style>
    html, body { height: 100%; margin: 0; background:#fafafa; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .toolbar { display:flex; gap:8px; align-items:center; padding:10px; border-bottom:1px solid #e6e6e6; background:#fff; position:sticky; top:0; z-index:10; }
    .toolbar a, .toolbar button { padding:8px 12px; border:1px solid #d8d8d8; background:#fff; border-radius:8px; cursor:pointer; text-decoration:none; color:#111; }
    .toolbar a:hover, .toolbar button:hover { background:#f3f3f3; }
    .hint { margin-left:auto; color:#666; font-size:12px; }
    #canvas { height: calc(100vh - 56px); }
  </style>
</head>
<body>
  <div class="toolbar">
    <a href="./index.html">← Vista General</a>
    <strong>SP2 · Consolidación y análisis (ordenado)</strong>
    <button id="btnFit">Ajustar</button>
    <button id="btnDownloadBPMN">.bpmn</button>
    <button id="btnDownloadSVG">.svg</button>
    <span class="hint">Happy path horizontal; excepción (error formato) abajo; líneas ortogonales</span>
  </div>
  <div id="canvas"></div>

  <script type="text/plain" id="bpmn-xml">
<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
  id="Defs_SP2_Orderly" targetNamespace="http://bpmn.io/schema/bpmn">

  <bpmn:process id="P_SP2" isExecutable="false" name="SP2 · Consolidación y análisis de resultados">
    <bpmn:startEvent id="SP2_Start" name="Inicio SP2">
      <bpmn:outgoing>F0</bpmn:outgoing>
    </bpmn:startEvent>

    <bpmn:task id="SP2_T_Ingresar" name="Ingresar datos al sistema / plantilla maestra">
      <bpmn:incoming>F0</bpmn:incoming>
      <bpmn:outgoing>F1</bpmn:outgoing>
    </bpmn:task>

    <bpmn:task id="SP2_T_Calcular" name="Calcular porcentajes, tasas y metas">
      <bpmn:incoming>F1</bpmn:incoming>
      <bpmn:outgoing>F2</bpmn:outgoing>
    </bpmn:task>

    <!-- Boundary Error por inconsistencias de formato (excepción ordenada debajo) -->
    <bpmn:boundaryEvent id="SP2_BE_Error" name="Inconsistencias de formato" attachedToRef="SP2_T_Calcular" cancelActivity="false">
      <bpmn:errorEventDefinition />
      <bpmn:outgoing>F_Error_toMsg</bpmn:outgoing>
    </bpmn:boundaryEvent>

    <bpmn:intermediateThrowEvent id="SP2_Evt_NotificarSP1" name="Notificar a responsables SP1 (mensaje)">
      <bpmn:incoming>F_Error_toMsg</bpmn:incoming>
      <bpmn:messageEventDefinition />
    </bpmn:intermediateThrowEvent>

    <bpmn:task id="SP2_T_Tablas" name="Generar tablas y gráficos comparativos">
      <bpmn:incoming>F2</bpmn:incoming>
      <bpmn:outgoing>F3</bpmn:outgoing>
    </bpmn:task>

    <bpmn:task id="SP2_T_Analizar" name="Analizar desviaciones vs objetivos">
      <bpmn:incoming>F3</bpmn:incoming>
      <bpmn:outgoing>F4</bpmn:outgoing>
    </bpmn:task>

    <bpmn:exclusiveGateway id="SP2_G_XOR" name="¿Desviaciones detectadas?">
      <bpmn:incoming>F4</bpmn:incoming>
      <bpmn:outgoing>F_SI</bpmn:outgoing>
      <bpmn:outgoing>F_NO</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:task id="SP2_T_Brechas" name="Registrar brechas y hallazgos">
      <bpmn:incoming>F_SI</bpmn:incoming>
      <bpmn:outgoing>F5a</bpmn:outgoing>
    </bpmn:task>

    <bpmn:task id="SP2_T_Matriz" name="Matriz consolidada con análisis de cumplimiento">
      <bpmn:incoming>F_NO</bpmn:incoming>
      <bpmn:outgoing>F5b</bpmn:outgoing>
    </bpmn:task>

    <bpmn:endEvent id="SP2_End" name="Fin SP2">
      <bpmn:incoming>F5a</bpmn:incoming>
      <bpmn:incoming>F5b</bpmn:incoming>
    </bpmn:endEvent>

    <!-- Data store y asociaciones -->
    <bpmn:dataStoreReference id="SP2_DS_Consolidados" name="Repositorio indicadores (consolidados)"/>

    <bpmn:dataOutputAssociation id="SP2_DA_Matriz_a_DS">
      <bpmn:sourceRef>SP2_T_Matriz</bpmn:sourceRef>
      <bpmn:targetRef>SP2_DS_Consolidados</bpmn:targetRef>
    </bpmn:dataOutputAssociation>

    <bpmn:dataOutputAssociation id="SP2_DA_Brechas_a_DS">
      <bpmn:sourceRef>SP2_T_Brechas</bpmn:sourceRef>
      <bpmn:targetRef>SP2_DS_Consolidados</bpmn:targetRef>
    </bpmn:dataOutputAssociation>

    <!-- Flujos de secuencia -->
    <bpmn:sequenceFlow id="F0" sourceRef="SP2_Start" targetRef="SP2_T_Ingresar"/>
    <bpmn:sequenceFlow id="F1" sourceRef="SP2_T_Ingresar" targetRef="SP2_T_Calcular"/>
    <bpmn:sequenceFlow id="F_Error_toMsg" sourceRef="SP2_BE_Error" targetRef="SP2_Evt_NotificarSP1"/>
    <bpmn:sequenceFlow id="F2" sourceRef="SP2_T_Calcular" targetRef="SP2_T_Tablas"/>
    <bpmn:sequenceFlow id="F3" sourceRef="SP2_T_Tablas" targetRef="SP2_T_Analizar"/>
    <bpmn:sequenceFlow id="F4" sourceRef="SP2_T_Analizar" targetRef="SP2_G_XOR"/>
    <bpmn:sequenceFlow id="F_SI" name="Sí" sourceRef="SP2_G_XOR" targetRef="SP2_T_Brechas"/>
    <bpmn:sequenceFlow id="F_NO" name="No" sourceRef="SP2_G_XOR" targetRef="SP2_T_Matriz"/>
    <bpmn:sequenceFlow id="F5a" sourceRef="SP2_T_Brechas" targetRef="SP2_End"/>
    <bpmn:sequenceFlow id="F5b" sourceRef="SP2_T_Matriz" targetRef="SP2_End"/>

    <!-- Nota -->
    <bpmn:textAnnotation id="SP2_Nota">
      <bpmn:text>Puntos críticos: automatizar cálculos y dashboards (BI), validar formatos de entrada.</bpmn:text>
    </bpmn:textAnnotation>
    <bpmn:association id="SP2_Assoc_Nota" sourceRef="SP2_T_Tablas" targetRef="SP2_Nota"/>
  </bpmn:process>

  <!-- DIAGRAM INTERCHANGE – Layout ordenado y líneas ortogonales -->
  <bpmndi:BPMNDiagram id="DI_SP2">
    <bpmndi:BPMNPlane id="PL_SP2" bpmnElement="P_SP2">
      <!-- Fila principal (y ~ 180) -->
      <bpmndi:BPMNShape id="SP2_Start_di" bpmnElement="SP2_Start"><dc:Bounds x="120" y="190" width="36" height="36"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SP2_T_Ingresar_di" bpmnElement="SP2_T_Ingresar"><dc:Bounds x="180" y="180" width="260" height="56"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SP2_T_Calcular_di" bpmnElement="SP2_T_Calcular"><dc:Bounds x="470" y="180" width="260" height="56"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SP2_T_Tablas_di" bpmnElement="SP2_T_Tablas"><dc:Bounds x="760" y="180" width="260" height="56"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SP2_T_Analizar_di" bpmnElement="SP2_T_Analizar"><dc:Bounds x="1050" y="180" width="260" height="56"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SP2_G_XOR_di" bpmnElement="SP2_G_XOR" isMarkerVisible="true"><dc:Bounds x="1340" y="192" width="40" height="40"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SP2_T_Matriz_di" bpmnElement="SP2_T_Matriz"><dc:Bounds x="1400" y="180" width="300" height="56"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SP2_End_di" bpmnElement="SP2_End"><dc:Bounds x="1720" y="190" width="36" height="36"/></bpmndi:BPMNShape>

      <!-- Rama Sí (brechas) en segunda fila (y ~ 340) -->
      <bpmndi:BPMNShape id="SP2_T_Brechas_di" bpmnElement="SP2_T_Brechas"><dc:Bounds x="1400" y="340" width="300" height="56"/></bpmndi:BPMNShape>

      <!-- Excepción de error de formato (debajo de Calcular) -->
      <bpmndi:BPMNShape id="SP2_BE_Error_di" bpmnElement="SP2_BE_Error"><dc:Bounds x="720" y="226" width="18" height="18"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SP2_Evt_NotificarSP1_di" bpmnElement="SP2_Evt_NotificarSP1"><dc:Bounds x="710" y="300" width="28" height="28"/></bpmndi:BPMNShape>

      <!-- Data store a la derecha -->
      <bpmndi:BPMNShape id="SP2_DS_Consolidados_di" bpmnElement="SP2_DS_Consolidados"><dc:Bounds x="1720" y="260" width="70" height="52"/></bpmndi:BPMNShape>

      <!-- Secuencias: ortogonales -->
      <bpmndi:BPMNEdge id="F0_di" bpmnElement="F0"><di:waypoint x="156" y="208"/><di:waypoint x="180" y="208"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="F1_di" bpmnElement="F1"><di:waypoint x="440" y="208"/><di:waypoint x="470" y="208"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="F2_di" bpmnElement="F2"><di:waypoint x="730" y="208"/><di:waypoint x="760" y="208"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="F3_di" bpmnElement="F3"><di:waypoint x="1020" y="208"/><di:waypoint x="1050" y="208"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="F4_di" bpmnElement="F4"><di:waypoint x="1310" y="208"/><di:waypoint x="1340" y="212"/></bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="F_NO_di" bpmnElement="F_NO">
        <di:waypoint x="1360" y="212"/><di:waypoint x="1400" y="208"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="F_SI_di" bpmnElement="F_SI">
        <!-- Baja vertical desde la XOR y luego derecha a la tarea Brechas -->
        <di:waypoint x="1360" y="212"/><di:waypoint x="1360" y="368"/><di:waypoint x="1400" y="368"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="F5b_di" bpmnElement="F5b"><di:waypoint x="1700" y="208"/><di:waypoint x="1720" y="208"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="F5a_di" bpmnElement="F5a"><di:waypoint x="1700" y="368"/><di:waypoint x="1720" y="208"/></bpmndi:BPMNEdge>

      <!-- Error -> Mensaje (línea corta debajo de Calcular) -->
      <bpmndi:BPMNEdge id="F_Error_toMsg_di" bpmnElement="F_Error_toMsg">
        <di:waypoint x="729" y="235"/><di:waypoint x="724" y="300"/>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
  </script>

  <script>
    (async function () {
      const modeler = new BpmnJS({ container: '#canvas' });
      const xml = document.getElementById('bpmn-xml').textContent.trim();

      try {
        await modeler.importXML(xml);
        modeler.get('canvas').zoom('fit-viewport', 'auto');
      } catch (err) {
        console.error('Error al importar BPMN:', err);
        alert('No se pudo cargar el diagrama. Revisa la consola.');
      }

      document.getElementById('btnFit').addEventListener('click', () => {
        modeler.get('canvas').zoom('fit-viewport', 'auto');
      });
      document.getElementById('btnDownloadBPMN').addEventListener('click', async () => {
        try {
          const { xml } = await modeler.saveXML({ format: true });
          download('sp2_consolidacion_analisis.bpmn', xml, 'text/xml');
        } catch (e) { console.error(e); }
      });
      document.getElementById('btnDownloadSVG').addEventListener('click', async () => {
        try {
          const { svg } = await modeler.saveSVG();
          download('sp2_consolidacion_analisis.svg', svg, 'image/svg+xml');
        } catch (e) { console.error(e); }
      });

      function download(filename, data, mime) {
        const blob = new Blob([data], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; a.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      }
    })();
  </script>
</body>
</html>
